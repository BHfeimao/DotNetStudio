<?xml version="1.0"?>
<dataOperations>
    <dataCommand name="GetTopOrderList" connectionStringName="SqlServerData" commandType="Text">
        <commandText>
            <![CDATA[
with TopOrderSource 
as 
(
select UserId,COUNT(ProductCount) as Total from OrderInfo(nolock)
group by UserId
)
select UserId,Total,Mobile,WxHeadUrl from TopOrderSource tops inner join [User] u on tops.UserId= u.ID

		]]>
        </commandText>
        
    </dataCommand>
  
      <dataCommand name="InsertOrder" connectionStringName="SqlServerData" commandType="Text">
        <commandText>
            <![CDATA[
  INSERT INTO [dbo].[OrderInfo]
           ([OrderId]
           ,[UserId]
           ,[CreateTime]
           ,[ProductId]
           ,[ProductCount]
           ,[Price]
           ,[Status]
           ,[PayType])
     VALUES
           (@OrderId
           ,@UserId
           ,@CreateTime
           ,@ProductId
           ,@ProductCount
           ,@Price
           ,@Status
           ,@PayType)
		]]>
        </commandText>
    <parameters>
      <param name="@OrderId" dbType="Int64" direction="Input" size="8" />
      <param name="@UserId" dbType="Int32" direction="Input" size="4" />
      <param name="@ProductId" dbType="Int32" direction="Input" size="4" />
      <param name="@ProductCount" dbType="Int32" direction="Input" size="4" />
      <param name="@Price" dbType="Decimal" direction="Input" size="18" />
      <param name="@Status" dbType="Int32" direction="Input" size="4" />
      <param name="@PayType" dbType="Int32" direction="Input" size="4" />
      <param name="@CreateTime" dbType="DateTime" direction="Input" size="8" />
    </parameters>
        
    </dataCommand>




  <dataCommand name="GetOrder" connectionStringName="SqlServerData" commandType="Text">
    <commandText>
      <![CDATA[
SELECT TOP 1 [OrderId]
      ,[UserId]
      ,[CreateTime]
      ,[ProductId]
      ,[ProductCount]
      ,[Price]
      ,[Status]
      ,[PayType]
  FROM [dbo].[OrderInfo] Where OrderId=@OrderId and UserId=@UserId;
		]]>
    </commandText>
    <parameters>
      <param name="@OrderId" dbType="Int64" direction="Input" size="8" />
      <param name="@UserId" dbType="Int32" direction="Input" size="4" />
    </parameters>

  </dataCommand>


  <dataCommand name="GetNewOrderId" connectionStringName="SqlServerData" commandType="Text">
    <commandText>
      <![CDATA[
DECLARE @LastNum bigint,@Currdate int
                            SET @Currdate=CONVERT(varchar(10),GETDATE(),12)
	                        update FrameCode
	                        set @LastNum=LastNum=LastNum+1
	                        where Currdate=@Currdate
	                        AND CType='Order'
                            if(@@RowCount=0)
                            BEGIN                           
                            SET @LastNum=0
                            WHILE(len(@LastNum)!=6 or @LastNum>990000)
                            begin
                            select @LastNum =cast(ceiling(rand() * 1000000) as int)
                            end
                            insert INTO FrameCode VALUES(@Currdate,'Order','',@LastNum)
                            end
                            SELECT '81'+cast(@Currdate AS varchar(6))+Cast(@LastNum as varchar(6))

		]]>
    </commandText>

  </dataCommand>

  <dataCommand name="GetOrderList" connectionStringName="SqlServerData" commandType="Text">
    <commandText>
      <![CDATA[
with DataSource
as
(
select o.*,p.ProductName from OrderInfo(nolock) o inner join Product(nolock) p
on o.ProductId=p.Id
),
PageDataSource
as 
(
select row_number() over (Order by CreateTime  desc) as RowsId,*  from DataSource
)
select * from PageDataSource
where RowsId between (1-1)*10 and 1*10 and UserId=161 
		]]>
    </commandText>
    <parameters>
      <param name="@UserId" dbType="Int32" direction="Input" size="4" />
      <param name="@PageIndex" dbType="Int32" direction="Input" size="4" />
      <param name="@PageSize" dbType="Int32" direction="Input" size="4" />
    </parameters>

  </dataCommand>
  

</dataOperations>
